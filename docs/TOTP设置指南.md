# 双因子认证 (TOTP) 设置指南

## 概述

双因子认证 (Two-Factor Authentication, 2FA) 为您的管理员账户提供额外的安全保护。启用后，除了用户名和密码外，还需要输入手机认证应用生成的6位验证码才能登录。

## 支持的认证应用

- **Google Authenticator** (推荐)
- **Microsoft Authenticator**
- **Authy**
- **1Password**
- 其他支持TOTP标准的认证应用

## 设置步骤

### 1. 进入系统设置

1. 登录管理员后台
2. 点击左侧菜单的"系统设置"
3. 找到"双因子认证 (TOTP)"部分

### 2. 启用双因子认证

1. 点击"启用双因子认证"按钮
2. 在弹出的设置向导中，点击"生成认证密钥"
3. 系统会生成专用的认证密钥和二维码

### 3. 配置认证应用

**方法一：扫描二维码**
1. 打开手机上的认证应用
2. 选择"添加账户"或"扫描二维码"
3. 扫描屏幕上显示的二维码

**方法二：手动输入密钥**
1. 如果无法扫描二维码，可以选择手动输入
2. 复制显示的密钥字符串
3. 在认证应用中选择"手动输入"
4. 输入账户名称和密钥

### 4. 验证设置

1. 认证应用会显示6位数字验证码
2. 在设置向导中输入当前显示的验证码
3. 点击"完成设置"
4. 看到"双因子认证设置成功"提示即完成

## 登录流程

启用双因子认证后，登录时需要：

1. 输入用户名和密码
2. 输入认证应用显示的6位验证码
3. 点击登录

⚠️ **注意**：验证码每30秒更新一次，请使用最新的验证码。

## 管理双因子认证

### 查看二维码
如果需要在其他设备上设置认证应用：
1. 进入"系统设置"
2. 在双因子认证部分点击"查看二维码"
3. 使用新设备扫描二维码

### 禁用双因子认证
⚠️ **重要**：禁用双因子认证会降低账户安全性

1. 进入"系统设置"
2. 点击"禁用双因子认证"
3. 确认禁用操作

**注意**：如果管理员启用了"强制双因子认证"，则无法禁用。

## 强制双因子认证

管理员可以在配置文件中启用强制双因子认证：

```yaml
# configs/app.yaml
security:
  force_totp: true
```

启用后：
- 所有管理员账户必须设置双因子认证
- 无法禁用已启用的双因子认证
- 新创建的管理员账户自动生成TOTP密钥

## 故障排除

### 验证码不正确
1. 确保手机时间与服务器时间同步
2. 使用最新的6位验证码（每30秒更新）
3. 检查是否输入了正确的验证码

### 无法扫描二维码
1. 确保手机摄像头权限已开启
2. 尝试调整手机与屏幕的距离
3. 使用手动输入密钥的方式

### 丢失认证设备
1. 联系其他管理员协助
2. 如果是唯一管理员，需要通过数据库直接清除TOTP密钥：
   ```sql
   UPDATE admin_users SET totp_secret = '' WHERE username = 'your_username';
   ```

## 安全建议

1. **备份密钥**：建议将TOTP密钥保存在安全的地方
2. **多设备设置**：可以在多个设备上设置同一个账户
3. **定期检查**：定期检查认证应用是否正常工作
4. **安全存储**：不要将认证应用和登录密码存储在同一设备上

## 技术细节

- 使用RFC 6238标准的TOTP算法
- 密钥长度：32字符（160位）
- 时间窗口：30秒
- 验证码长度：6位数字
- 发行者：LicenseCenter 