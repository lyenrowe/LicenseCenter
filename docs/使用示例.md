# LicenseCenter 使用示例

本文档演示如何使用 LicenseCenter 进行完整的授权管理流程。

## 1. 系统初始化

### 1.1 构建和初始化

```bash
# 1. 构建所有程序
make build

# 2. 初始化系统数据（创建默认管理员、RSA密钥等）
make init-system

# 3. 启动服务器
make run
```

### 1.2 验证服务状态

```bash
# 检查服务健康状态
curl http://localhost:8080/health

# 获取服务端公钥
curl http://localhost:8080/api/public-key
```

## 2. 管理员操作

### 2.1 管理员登录

```bash
# 使用默认管理员账号登录
curl -X POST http://localhost:8080/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 响应示例：
# {
#   "admin": {"id": 1, "username": "admin"},
#   "expires_in": 1800,
#   "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
# }
```

保存返回的 `token` 用于后续管理员操作。

### 2.2 查看控制台

```bash
# 设置令牌变量
TOKEN="your_jwt_token_here"

# 查看管理员控制台
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/admin/dashboard
```

### 2.3 创建授权码

```bash
# 创建授权码
curl -X POST -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "customer_name": "测试客户",
    "max_seats": 5,
    "duration_years": 1
  }' \
  http://localhost:8080/api/admin/authorizations

# 响应示例：
# {
#   "data": {
#     "id": 1,
#     "customer_name": "测试客户",
#     "authorization_code": "9C1-719-48F",
#     "max_seats": 5,
#     "used_seats": 0,
#     "duration_years": 1,
#     "status": 1,
#     ...
#   }
# }
```

记录返回的 `authorization_code`，这就是提供给客户的授权码。

### 2.4 查看授权码列表

```bash
# 查看所有授权码
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/admin/authorizations"

# 分页查询
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/admin/authorizations?page=1&limit=10"

# 搜索授权码
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/admin/authorizations?search=测试客户"
```

## 3. 客户端操作

### 3.1 生成绑定文件

在需要激活的设备上：

```bash
# 生成绑定文件
./bin/test-client generate-bind

# 这会生成类似 Mac-mini-2.bind 的文件
# 文件内容包含：主机名、机器ID、请求时间
```

### 3.2 激活设备

```bash
# 读取绑定文件内容
BIND_CONTENT=$(cat Mac-mini-2.bind)

# 使用授权码激活设备
curl -X POST -H "Content-Type: application/json" \
  -d '{
    "authorization_code": "9C1-719-48F",
    "bind_files": ['"$BIND_CONTENT"']
  }' \
  http://localhost:8080/api/licenses/activate

# 响应示例：
# {
#   "license_files": [{
#     "license_data": {
#       "machine_id": "366a8597c1c80388470d830f0a7c5417953bfc4a01b9c6eb301bfb2e68f27fb7",
#       "issued_at": "2025-06-28T23:09:52.593666+08:00",
#       "expires_at": "2026-06-28T23:09:52.424665+08:00",
#       "license_type": "FULL",
#       "unbind_private_key": "-----BEGIN PRIVATE KEY-----\n..."
#     },
#     "signature": "fdD6STmCxVI5UBgYGmhGvliapT74aD0MzMh8i5uFUYEs..."
#   }],
#   "message": "设备激活成功"
# }
```

保存返回的 `license_files` 到设备本地，这就是设备的授权文件。

### 3.3 查询设备列表

```bash
# 查询授权码下的所有设备
curl "http://localhost:8080/api/licenses?auth_code=9C1-719-48F"

# 响应包含该授权码下所有已激活的设备信息
```

## 4. 授权转移

### 4.1 生成解绑文件

在旧设备上，使用之前保存的授权文件：

```bash
# 这里需要客户端程序来生成解绑文件
# 解绑文件包含：原授权文件 + 解绑证明
```

### 4.2 执行授权转移

```bash
# 准备新设备的绑定文件
NEW_BIND_CONTENT=$(cat new-device.bind)

# 执行授权转移
curl -X POST -H "Content-Type: application/json" \
  -d '{
    "authorization_code": "9C1-719-48F",
    "unbind_file": {
      "signed_license": {...},
      "unbind_proof": "..."
    },
    "bind_file": '"$NEW_BIND_CONTENT"'
  }' \
  http://localhost:8080/api/licenses/transfer
```

## 5. 管理员高级操作

### 5.1 强制解绑设备

```bash
# 强制解绑指定设备
curl -X DELETE -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"reason": "设备丢失"}' \
  http://localhost:8080/api/admin/licenses/1/unbind
```

### 5.2 查看操作日志

```bash
# 查看管理员操作日志
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/admin/logs"

# 分页和筛选
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/admin/logs?page=1&limit=20&action=create_authorization"
```

### 5.3 更新授权码

```bash
# 增加席位数
curl -X PUT -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"max_seats": 10}' \
  http://localhost:8080/api/admin/authorizations/1

# 禁用授权码
curl -X PUT -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"status": 0}' \
  http://localhost:8080/api/admin/authorizations/1
```

## 6. 常见问题

### 6.1 授权码无效

- 检查授权码是否正确
- 确认授权码状态是否为启用
- 验证授权码是否已过期

### 6.2 席位不足

- 检查授权码的最大席位数
- 查看已使用的席位数
- 考虑增加席位或解绑不需要的设备

### 6.3 设备已激活

- 一台设备只能激活一次
- 如需重新激活，先解绑再激活
- 或使用授权转移功能

### 6.4 签名验证失败

- 检查系统时间是否正确
- 确认绑定文件格式是否正确
- 验证机器ID是否有效

## 7. 安全建议

1. **及时修改默认密码**：系统初始化后立即修改管理员密码
2. **定期轮换密钥**：建议定期轮换RSA密钥对
3. **监控操作日志**：定期检查管理员操作日志
4. **备份数据库**：定期备份授权数据库
5. **网络安全**：在生产环境中配置HTTPS和防火墙

## 8. 故障排除

### 8.1 服务无法启动

```bash
# 检查端口是否被占用
lsof -i:8080

# 检查配置文件
cat configs/app.yaml

# 查看错误日志
tail -f logs/app.log
```

### 8.2 数据库问题

```bash
# 重置数据库
make reset-db

# 重新初始化
make init-system
```

### 8.3 权限问题

```bash
# 检查JWT令牌是否有效
# 确认管理员账户状态
# 验证请求头格式
``` 