# 初始化脚本使用指南

## 概述

修改后的初始化脚本 (`cmd/init/main.go`) 提供了交互式的系统初始化功能，包括：

1. **交互式管理员账户创建** - 通过命令行安全输入管理员密码
2. **双因子认证设置** - 自动显示二维码供用户扫描设置
3. **密码安全输入** - 密码输入时不会显示在屏幕上

## 使用方法

### 1. 编译脚本

```bash
go build -o bin/init cmd/init/main.go
```

### 2. 运行初始化

```bash
./bin/init
```

### 3. 交互式流程

脚本会引导您完成以下步骤：

#### 步骤1：RSA密钥生成
```
开始初始化系统...
====================================
生成RSA密钥对...
✓ RSA密钥对生成成功
```

#### 步骤2：创建管理员账户
```
创建管理员账户...
====================================
请输入管理员用户名 (默认: admin): [您的输入]
请输入管理员密码 (至少6位): [隐藏输入]
请再次输入密码确认: [隐藏输入]
✓ 管理员创建成功 - 用户名: admin
```

#### 步骤3：双因子认证设置（如果启用）
如果系统配置了强制TOTP (`config.AppConfig.Security.ForceTOTP = true`)，脚本会自动进行双因子认证设置：

```
设置双因子认证...
====================================
系统启用了强制双因子认证，正在为您设置...
双因子认证设置:
请使用Google Authenticator、Microsoft Authenticator等应用扫描以下二维码:

认证器密钥URL: otpauth://totp/LicenseCenter:admin?secret=...&issuer=LicenseCenter

二维码:
========================================
█▀▀▀▀▀█ ▀▀ █▀ █▀▀▀▀▀█
█ ███ █ ▀▀▀  ▀ █ ███ █
█ ▀▀▀ █  ▀█▀▀  █ ▀▀▀ █
▀▀▀▀▀▀▀ █ ▀ █ █▀▀▀▀▀▀▀
... (ASCII二维码显示)
========================================
或者您可以使用以下方式:
1. 扫描上面的二维码
2. 手动输入URL到认证器应用
   URL: otpauth://totp/LicenseCenter:admin?secret=...
3. 如需更清晰的二维码，可安装qrencode:
   macOS: brew install qrencode
   然后运行: echo 'otpauth://...' | qrencode -t ANSI

设置完成后，请使用认证器生成的6位数字码进行验证:
请输入认证器显示的6位数字码: [您的输入]
✓ 双因子认证设置成功!
```

#### 步骤4：完成初始化
```
系统初始化完成!
====================================
管理员账号: admin
双因子认证: 已启用
请使用认证器应用扫描上面的二维码完成设置

请及时备份您的认证信息!
```

## 功能特性

### 1. 安全密码输入
- 密码输入时不会在终端显示
- 支持密码确认验证
- 强制最少6位密码长度

### 2. 智能双因子认证
- 自动检测系统是否启用强制TOTP
- 生成标准的TOTP密钥和二维码
- 支持多种认证器应用（Google Authenticator、Microsoft Authenticator等）
- 实时验证TOTP码的有效性

### 3. 友好的用户界面
- 清晰的步骤分隔和提示信息
- ASCII艺术二维码显示
- 多种二维码输入方式（扫描、手动输入、命令行工具）

### 4. 错误处理
- 密码不匹配检测
- TOTP验证失败重试机制
- 详细的错误提示信息

## 配置要求

### 强制双因子认证
在 `configs/app.yaml` 中设置：

```yaml
security:
  force_totp: true  # 启用强制双因子认证
```

如果启用此选项，所有新创建的管理员都必须设置双因子认证。

## 注意事项

1. **备份重要信息**：请务必备份管理员密码和TOTP密钥
2. **安全运行环境**：请在安全的环境中运行初始化脚本
3. **认证器应用**：确保手机上安装了支持TOTP的认证器应用
4. **终端支持**：ASCII二维码在某些终端中可能显示不佳，可使用备选方案

## 支持的认证器应用

- Google Authenticator
- Microsoft Authenticator
- Authy
- 1Password
- LastPass Authenticator
- 任何支持TOTP标准的认证器应用

## 故障排除

### 二维码显示异常
如果ASCII二维码显示不正常，可以：
1. 使用手动输入URL的方式
2. 安装 `qrencode` 工具生成更清晰的二维码
3. 复制URL到浏览器中生成二维码

### TOTP验证失败
1. 确保手机时间与服务器时间同步
2. 检查输入的6位数字码是否正确
3. 等待新的验证码生成后重试

### 数据库连接失败
1. 检查数据库配置文件 `configs/app.yaml`
2. 确保数据库服务正在运行
3. 验证数据库连接权限 