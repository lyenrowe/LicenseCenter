# OCR2Doc 离线授权方案设计 (v2)

## 1. 方案概述

本方案为OCR2Doc项目设计一套完整的**纯离线授权**系统，包括服务端授权管理和客户端授权验证。系统采用"授权码-席位"模型，通过交换离线文件（绑定/授权文件）完成激活，并支持安全的**授权转移**（解绑/重绑定）。

### 1.1 设计目标

- **完全离线**：客户端在激活、验证和运行过程中**无需任何网络连接**。
- **安全可控**：采用RSA-2048非对称加密，防止授权伪造；授权与硬件绑定。
- **授权转移**：支持在旧设备上安全解绑，释放授权席位，以便在新设备上激活。
- **模型简化**：软件只有"未授权"、"试用"和"正式授权"状态，通过有效期区分。
- **席位管理**：一个授权码关联一个客户和固定的设备授权数（席位）。

### 1.2 技术架构

```
┌──────────────────┐      ┌──────────┐      ┌──────────────────┐
│   授权服务端     │      │   U盘等   │      │   OCR2Doc客户端  │
│  (LicenseCenter) │      │  离线介质  │      │    (永不联网)    │
│                  │      │          │      │                  │
│  ┌───────────┐   │      │          │      │  ┌───────────┐   │
│  │ 授权管理UI│   │◄─────► Bind/License ◄───►│  │ 授权管理  │   │
│  └───────────┘   │      │   文件   │      │  └───────────┘   │
│  ┌───────────┐   │      │          │      │  ┌───────────┐   │
│  │ SQLite数据库│   │      └──────────┘      │  │ 本地授权  │   │
│  └───────────┘   │                        │  └───────────┘   │
└──────────────────┘                        └──────────────────┘
```

## 2. 核心工作流程

### 2.1 客户控制台与登录

为了提供统一的管理界面，所有面向客户的操作都将在一个安全的网页控制台（Dashboard）中进行。

#### 2.1.1 登录与防机器人验证
客户通过其唯一的**授权码**来访问控制台。为防止授权码被恶意程序暴力破解或滥用，登录页面必须集成防机器人验证机制。

-   **方案建议**: 推荐使用 **hCaptcha** 或 Google reCAPTCHA v2。用户在输入授权码后，需要完成一次人机验证挑战。
-   **登录流程**:
    1.  用户在登录页面输入`授权码`。
    2.  用户完成 hCaptcha 人机验证，获得一个一次性的`验证令牌`。
    3.  前端将`授权码`和`验证令牌`一并提交给服务端。
    4.  服务端首先向 hCaptcha 的验证服务器确认`验证令牌`的有效性，通过后再验证`授权码`。
    5.  验证成功后，服务端返回一个具有时效性（如1小时）的`Session Token`，用于后续所有API请求的身份认证。

#### 2.1.2 客户控制台 (Dashboard) 概览
成功登录后，用户将看到一个清晰的控制台界面，展示所有与授权相关的信息和操作。

**UI界面设计草图:**
```
+-----------------------------------------------------------------------------+
| OCR2Doc 授权管理控制台                                       [注销登录] |
+-----------------------------------------------------------------------------+
| 欢迎, [客户名称]                                                            |
| 您的授权码: ABC-DEF-GHI                                                     |
|                                                                             |
| 授权席位状态:  3 / 10 (已用/总量)                                            |
+-----------------------------------------------------------------------------+
|                                                                             |
| [ 功能区 ]                                                                  |
|                                                                             |
|  ┌───────────────────┐        ┌───────────────────────┐                     |
|  │   新设备授权      │        │      转移授权         │                     |
|  └───────────────────┘        └───────────────────────┘                     |
|    (支持批量上传.bind文件)         (上传.unbind和.bind文件)                     |
|                                                                             |
+-----------------------------------------------------------------------------+
| [ 已激活设备列表 (3) ]                                                      |
+-----------------------------------------------------------------------------+
| 主机名        | 机器ID (部分)     | 激活日期     | 到期日期     | 操作        |
|---------------+-------------------+--------------+--------------+-------------|
| DESIGN-PC-01  | c875d9a8a5...     | 2024-07-30   | 2025-07-29   | [下载.license] |
| LAB-SERVER-02 | ffe312aabc...     | 2024-07-28   | 2025-07-27   | [下载.license] |
| DEV-VM-W11    | 1b9a4d8721...     | 2024-06-15   | 2025-06-14   | [下载.license] |
+-----------------------------------------------------------------------------+
| [ 已解绑/历史设备列表 (1) ]                                                 |
+-----------------------------------------------------------------------------+
| 主机名        | 机器ID (部分)     | 解绑日期     | 原始到期日   | 状态        |
|---------------+-------------------+--------------+--------------+-------------|
| OLD-PC-007    | 9a8b7c6d5e...     | 2024-07-29   | 2025-07-28   | 已转移      |
+-----------------------------------------------------------------------------+
```

### 2.2 新设备激活流程

1.  **客户端 (新设备)**：用户在未授权的设备上运行程序，生成包含**机器ID**和**主机名**的`.bind`文件。如果需要激活多台设备，则生成多个`.bind`文件。
2.  **离线传输**：用户收集所有需要激活的`.bind`文件（例如 `a.bind`, `b.bind`）。
3.  **服务端 (控制台)**：用户登录控制台，进入"新设备授权"功能区，批量上传这些`.bind`文件。
4.  **服务端**：系统检查可用席位是否足够（即 `max_seats - used_seats >= 上传文件数量`）。如果足够，则为每一个上传的`.bind`文件执行授权操作，并消耗相应数量的席位。
5.  **生成与下载**：对于每个`.bind`文件，服务端执行以下操作：
    *   **计算有效期**: 新授权的到期时间 (`expires_at`) 将根据授权码设定的 `duration_years` (从当前时间计算) 和 `latest_expiry_date` (固定日期)来决定，取两者中较早的日期。
    *   **生成授权**: 按照标准流程（含一次性解绑密钥）生成`.license`文件。
    *   **更新计数**: 将对应`authorizations`记录的`used_seats`字段加1。
    *   所有`.license`文件生成后，打包成一个ZIP文件供用户下载，且文件名与上传的`.bind`文件对应（如 `a.license`, `b.license`）。
6.  **客户端激活**：用户将对应的`.license`文件分发到各新设备上并导入，完成激活。

### 2.3 授权转移流程

此流程将旧设备的解绑和新设备的激活合并为一个原子操作，确保席位不会被凭空占用或丢失，并延续授权有效期。

1.  **客户端 (旧设备)**：用户在旧设备上点击"取消授权"，生成`.unbind`文件（此过程与之前定义一致）。本地授权立即失效。
2.  **客户端 (新设备)**：用户在新设备上生成新的`.bind`文件。
3.  **离线传输**：用户将旧设备的`.unbind`文件和新设备的`.bind`文件都拷贝到联网电脑。
4.  **服务端 (控制台)**：用户登录控制台，进入"转移授权"功能区，同时上传这两个文件。
5.  **服务端**：系统执行以下原子化操作：
    *   **验证解绑文件**：对`.unbind`文件进行双重验证，确认其合法性。
    *   **处理席位与记录**: 验证通过后，将旧设备记录标记为`unbound`。由于是转移操作，`used_seats`的总数保持不变。
    *   **生成新授权**：使用新的`.bind`文件和**旧授权的到期日期**来生成新的`.license`文件。新授权将继承旧授权的所有属性，只是绑定了新的机器ID和主机名。
6.  **激活新设备**：用户下载新生成的`.license`文件，拷贝回新设备并导入，完成授权转移。

## 3. 数据库设计 (简化版)

### 3.1 客户与授权码表 (authorizations)

管理客户购买的授权码、席位、有效期规则等核心信息。

```sql
CREATE TABLE authorizations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    customer_name VARCHAR(255) NOT NULL,
    authorization_code VARCHAR(255) UNIQUE NOT NULL, -- 客户购买的唯一授权码
    max_seats INTEGER NOT NULL, -- 总席位数
    used_seats INTEGER NOT NULL DEFAULT 0, -- 已使用席位数，在激活和解绑时更新
    duration_years INTEGER, -- 授权年限 (例如 1, 5, 99 表示永久)。优先级低于 latest_expiry_date
    latest_expiry_date DATETIME, -- 最晚过期时间点，所有基于此授权码生成的license有效期不能超过此日期
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    status INTEGER DEFAULT 1 -- 1:有效 0:禁用
);
```

### 3.2 已激活设备表 (licenses)

记录每一台被激活的设备。

```sql
CREATE TABLE licenses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    authorization_id INTEGER NOT NULL,
    license_key TEXT UNIQUE NOT NULL, -- .license文件内容的哈希或唯一标识
    machine_id VARCHAR(255) NOT NULL, -- 绑定的机器ID
    hostname VARCHAR(255), -- 客户端主机名，方便用户辨识
    unbind_public_key TEXT, -- 用于验证解绑凭证的一次性公钥
    issued_at DATETIME NOT NULL,
    expires_at DATETIME,
    status VARCHAR(50) NOT NULL, -- 'active', 'unbound' (客户解绑), 'force_unbound' (管理员强制解绑)
    activated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    unbound_at DATETIME,
    FOREIGN KEY (authorization_id) REFERENCES authorizations (id)
);
```

### 3.3 密钥管理表 (rsa_keys) - (无变化)

```sql
CREATE TABLE rsa_keys (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    private_key TEXT NOT NULL,
    public_key TEXT NOT NULL,
    is_active INTEGER DEFAULT 1
);
```

## 4. 文件格式定义

### 4.1 文件加密机制（v2.1 新增）

为了防止用户篡改授权文件，所有文件（`.bind`、`.license`、`.unbind`）都使用**混合加密**方案进行保护：

#### 4.1.1 混合加密原理

采用与HTTPS相同的混合加密方案：
1. **客户端**：生成随机AES-256密钥 → 用AES加密JSON数据 → 用服务端RSA公钥加密AES密钥
2. **服务端**：用RSA私钥解密AES密钥 → 用AES密钥解密JSON数据

#### 4.1.2 加密文件格式

```
加密文件结构：
[4字节AES密钥长度][RSA加密的AES密钥][AES-GCM加密的JSON数据]
↓ Base64编码
最终文件内容：Base64编码的加密数据
```

#### 4.1.3 优势

- **安全性强**：只有服务端能解密，用户无法篡改
- **无长度限制**：可以处理任意大小的JSON数据
- **防篡改**：任何修改都会导致解密失败
- **行业标准**：与HTTPS使用相同的加密原理

### 4.2 绑定请求文件 (`.bind`)

客户端在未授权设备上生成的文件，用于申请授权。

#### 原始JSON格式（仅内部使用）
```json
{
    "hostname": "DESIGN-PC-01",
    "machine_id": "c875d9a8a5843408a28896a297f6c326b5d3a549d4352163140a3317c24a354b",
    "request_time": "2024-07-30T10:00:00Z"
}
```

#### 实际文件内容（加密后）
```
eyJlbmNyeXB0ZWRfa2V5IjoiSkJMR3h3anQ5S1VwWlNKQ0Q4cXBlRHg4NXJhQVlKNV..."
```
*用户看到的是Base64编码的加密数据，无法直接读取或修改*

### 4.3 授权文件 (`.license`)

服务端为合法客户生成的授权凭证，包含完整的授权信息和解绑能力。

#### 原始JSON格式（仅内部使用）
```json
{
    "license_data": {
        "license_key": "LIC-c875d9a8-20240730-001",
        "machine_id": "c875d9a8a5843408a28896a297f6c326b5d3a549d4352163140a3317c24a354b",
        "hostname": "DESIGN-PC-01",
        "issued_at": "2024-07-30T10:05:00Z",
        "expires_at": "2025-07-30T23:59:59Z",
        "license_type": "FULL",
        "unbind_private_key": "base64编码的一次性解绑私钥"
    },
    "signature": "base64编码的(对整个license_data使用'服务端主私钥'的RSA签名)"
}
```

**字段说明**：
- `license_key`: 授权文件的唯一标识符，用于快速定位和管理
- `machine_id`: 绑定的机器唯一标识，确保授权不能跨设备使用
- `hostname`: 主机名，便于用户识别设备
- `issued_at`: 授权签发时间
- `expires_at`: 授权到期时间
- `license_type`: 授权类型（TRIAL试用版、FULL正式版）
- `unbind_private_key`: 一次性解绑私钥，用于生成合法的解绑凭证
- `signature`: 服务端的数字签名，确保授权文件不被篡改

#### 实际文件内容（加密后）
```
bXlFbmNyeXB0ZWRMaWNlbnNlRmlsZUNvbnRlbnRIZXJlQWZ0ZXJIeWJyaWRFbmNy...
```

### 4.4 解绑凭证文件 (`.unbind`)

客户端在执行解绑操作时生成的凭证，用于向服务端证明已经真实执行了解绑。

#### 原始JSON格式（仅内部使用）
```json
{
    "license_key": "LIC-c875d9a8-20240730-001",
    "machine_id": "c875d9a8a5843408a28896a297f6c326b5d3a549d4352163140a3317c24a354b",
    "unbind_metadata": {
        "unbind_time": "2024-07-30T15:30:00Z",
        "hostname": "DESIGN-PC-01",
        "client_version": "1.0.0",
        "unbind_reason": "user_initiated"
    },
    "unbind_proof": "base64编码的(使用一次性解绑私钥对上述所有信息的RSA签名)"
}
```

**字段说明**：
- `license_key`: 原授权文件的唯一标识，用于快速定位数据库记录
- `machine_id`: 机器标识，确保解绑请求来自正确的设备
- `unbind_metadata`: 解绑操作的元数据
  - `unbind_time`: 解绑操作的时间戳
  - `hostname`: 执行解绑的主机名
  - `client_version`: 客户端版本信息
  - `unbind_reason`: 解绑原因（user_initiated用户主动、device_replacement设备更换等）
- `unbind_proof`: 使用一次性解绑私钥生成的签名，证明持有合法授权

#### 实际文件内容（加密后）
```
dW5iaW5kRmlsZUVuY3J5cHRlZENvbnRlbnRXaXRoSHlicmlkRW5jcnlwdGlvblNj...
```

**解绑凭证验证流程**：
1. **服务端解密**：使用混合解密算法还原JSON内容
2. **查找授权记录**：通过`license_key`在数据库中查找对应的激活记录
3. **验证机器ID**：确认`machine_id`与数据库记录匹配
4. **验证解绑签名**：使用数据库中存储的`unbind_public_key`验证`unbind_proof`
5. **检查授权状态**：确认该授权当前状态为`active`，未被解绑过
6. **更新状态**：验证通过后，将授权状态更新为`unbound`，释放席位

### 4.5 文件处理流程

#### 客户端生成文件流程
```
1. 创建JSON数据
2. 从服务端获取RSA公钥（通过API）
3. 使用混合加密算法加密JSON
4. 将加密结果Base64编码后写入文件
```

#### 服务端处理文件流程
```
1. 读取文件内容（Base64字符串）
2. Base64解码得到加密数据
3. 使用服务端RSA私钥进行混合解密
4. 得到原始JSON数据进行业务处理
```

## 5. 安全机制设计

### 5.1 加密与签名

#### 5.1.1 混合加密方案（v2.1）
- **AES-256-GCM**：用于加密所有文件内容，提供机密性和完整性保护
- **RSA-2048-OAEP**：用于加密AES密钥，解决RSA长度限制问题  
- **随机AES密钥**：每个文件使用不同的随机密钥，提高安全性
- **Base64编码**：便于文件存储和传输

#### 5.1.2 数字签名
- **RSA-2048-PSS**：用于对`.license`授权文件和`.unbind`解绑凭证进行数字签名，确保其不可伪造和篡改
- **SHA-256**：用于数字签名的哈希算法和机器唯一标识生成

#### 5.1.3 其他安全机制  
- **人机验证 (Captcha)**：用于保护登录入口，防止自动化脚本攻击
- **会话管理**：JWT令牌机制，支持令牌过期和黑名单

### 5.2 防篡改机制

#### 5.2.1 文件级别保护（v2.1 新增）
1. **混合加密保护**：所有文件使用混合加密，用户无法查看或修改文件内容
2. **解密验证**：任何文件修改都会导致解密失败，自动检测篡改
3. **密钥隔离**：只有服务端持有解密私钥，客户端无法伪造文件

#### 5.2.2 内容级别保护
1. **服务端主签名**：`.license`授权文件由服务端主私钥签名，客户端内置主公钥进行验证，防止授权内容被篡改
2. **机器绑定**：授权文件与唯一的机器ID绑定，防止授权文件在不同设备间复制使用
3. **安全解绑凭证**：解绑流程采用"一次性密钥"机制。解绑能力（即一次性私钥）由服务端在授权时授予，并安全地封装在主签名之内。只有持有合法授权的客户端才能提取出这把私钥，生成有效的解绑证明

#### 5.2.3 多层防护体系
```
用户可见文件（Base64加密数据）
    ↓ 混合解密验证
内部JSON数据
    ↓ 数字签名验证  
授权内容
    ↓ 机器ID绑定验证
最终授权状态
```

#### 5.2.1 客户端伪造风险说明
本方案设计的核心是信任链的传递，而非绝对的防破解。需要明确一点：**任何运行在客户端上的代码和数据，对于有足够技术能力和决心的用户来说，理论上都是透明和可分析的。**

用户在了解上述完整的算法流程后，确实存在"假解绑"的可能：
-   **行为**：用户可以编写一个独立的程序，模拟客户端的解绑操作（提取一次性私钥、签名），生成合法的`.unbind`文件并发送给服务端以释放席位，但**同时在本地保留原始的`.license`授权文件而不使其失效**，从而实现"一号多用"。
-   **定性**：这种行为本质上不属于"伪造"签名，而是利用了对客户端环境的完全控制权，绕过了客户端的"解绑后自毁"的约定。这应被视为一种**客户端破解行为**。
-   **应对**：对此类风险的防御，重心在于提升客户端的逆向工程难度，例如代码混淆、加壳、完整性校验等，这些属于客户端软件保护的范畴，已超出授权协议设计的范畴。

### 5.3 防系统时间篡改

为防止用户通过修改系统时间来绕过有效期限制，客户端应实施以下策略：
- **安全时间戳**：在本地一个隐蔽位置（如注册表、特定文件）加密存储上一次成功运行的系统时间。
- **启动校验**：每次启动时，读取并解密该时间戳。如果当前系统时间早于记录的"上次运行时间"，则判定为时间篡改，**拒绝运行**并提示用户修正系统时间。

## 6. 管理员控制台设计

### 6.1 管理员认证与访问

管理员控制台与客户控制台分离，使用独立的认证机制：

#### 6.1.1 管理员登录
- **访问路径**: `/admin/login`
- **认证方式**: 用户名 + 密码 + 双因素认证（推荐使用TOTP）
- **会话管理**: 管理员会话超时时间较短（如30分钟），需要定期重新认证

#### 6.1.2 管理员控制台界面设计

```
+-----------------------------------------------------------------------------+
| OCR2Doc 授权管理系统 - 管理员控制台                         [注销] [设置] |
+-----------------------------------------------------------------------------+
| 欢迎, 管理员                                                               |
| 当前时间: 2024-07-30 15:30:25                                              |
+-----------------------------------------------------------------------------+
| [ 快速统计 ]                                                               |
| 总授权码: 25    活跃客户: 18    总席位: 150    已用席位: 89                |
+-----------------------------------------------------------------------------+
| [ 功能导航 ]                                                               |
|                                                                             |
|  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            |
|  │   授权码管理    │  │   客户管理      │  │   系统设置      │            |
|  │                 │  │                 │  │                 │            |
|  │ • 创建授权码    │  │ • 查看客户列表  │  │ • 密钥管理      │            |
|  │ • 查询授权码    │  │ • 客户详情      │  │ • 系统日志      │            |
|  │ • 修改授权码    │  │ • 强制解绑      │  │ • 数据备份      │            |
|  │ • 禁用授权码    │  │                 │  │                 │            |
|  └─────────────────┘  └─────────────────┘  └─────────────────┘            |
+-----------------------------------------------------------------------------+
```

### 6.2 核心管理功能

#### 6.2.1 授权码管理

**创建新授权码**
```
┌─────────────────────────────────────────────────────────────────────────┐
│ 创建新授权码                                                            │
├─────────────────────────────────────────────────────────────────────────┤
│ 客户名称: [__________________]                                          │
│ 授权码:   [ABC-DEF-GHI-JKL] [自动生成] [手动输入]                       │
│ 最大席位: [____] 个                                                     │
│ 授权年限: [____] 年 (99=永久)                                           │
│ 最晚到期: [2025-12-31] (可选，优先级高于授权年限)                       │
│ 备注:     [_________________________________]                           │
│                                                                         │
│                              [创建] [取消]                              │
└─────────────────────────────────────────────────────────────────────────┘
```

**授权码列表与操作**
```
+-----------------------------------------------------------------------------+
| 授权码管理 - 共25个授权码                                    [+ 创建新授权码] |
+-----------------------------------------------------------------------------+
| 搜索: [____________] [搜索] | 状态: [全部▼] | 排序: [创建时间▼]              |
+-----------------------------------------------------------------------------+
| 授权码        | 客户名称    | 席位使用  | 到期时间   | 状态   | 操作          |
|---------------|-------------|-----------|------------|--------|---------------|
| ABC-DEF-001   | 张三公司    | 5/10      | 2025-07-30 | 正常   | [详情][编辑][禁用] |
| ABC-DEF-002   | 李四工作室  | 2/5       | 2025-06-15 | 正常   | [详情][编辑][禁用] |
| ABC-DEF-003   | 王五科技    | 8/8       | 2024-12-31 | 即将到期| [详情][编辑][续期] |
| ABC-DEF-004   | 赵六企业    | 0/3       | 2025-03-20 | 禁用   | [详情][编辑][启用] |
+-----------------------------------------------------------------------------+
| 显示 1-4 / 25                                            [上一页] [下一页]  |
+-----------------------------------------------------------------------------+
```

#### 6.2.2 客户详情管理

**客户详细信息页面**
```
+-----------------------------------------------------------------------------+
| 客户详情: 张三公司 (ABC-DEF-001)                            [返回列表]     |
+-----------------------------------------------------------------------------+
| 基本信息:                                                                   |
| • 授权码: ABC-DEF-001                                                       |
| • 最大席位: 10                                                              |
| • 已用席位: 5                                                               |
| • 创建时间: 2024-01-15 10:30:00                                             |
| • 授权年限: 1年                                                             |
| • 最晚到期: 2025-07-30                                                      |
| • 状态: 正常                                                                |
+-----------------------------------------------------------------------------+
| 已激活设备 (5):                                                             |
+-----------------------------------------------------------------------------+
| 主机名        | 机器ID (部分)     | 激活时间     | 到期时间     | 操作        |
|---------------|-------------------|--------------|--------------|-------------|
| OFFICE-PC-01  | c875d9a8a5...     | 2024-02-01   | 2025-02-01   | [强制解绑]  |
| SERVER-001    | ffe312aabc...     | 2024-02-15   | 2025-02-15   | [强制解绑]  |
| DEV-LAPTOP    | 1b9a4d8721...     | 2024-03-01   | 2025-03-01   | [强制解绑]  |
| BACKUP-VM     | 8a7b6c5d4e...     | 2024-03-15   | 2025-03-15   | [强制解绑]  |
| TEST-PC       | 9f8e7d6c5b...     | 2024-04-01   | 2025-04-01   | [强制解绑]  |
+-----------------------------------------------------------------------------+
| 历史解绑设备 (2):                                                           |
+-----------------------------------------------------------------------------+
| 主机名        | 机器ID (部分)     | 解绑时间     | 解绑方式     | 状态        |
|---------------|-------------------|--------------|--------------|-------------|
| OLD-PC-007    | 9a8b7c6d5e...     | 2024-03-20   | 客户解绑     | 已转移      |
| TEMP-VM       | 4d3c2b1a09...     | 2024-04-10   | 管理员强制   | 已释放      |
+-----------------------------------------------------------------------------+
```

#### 6.2.3 必要的管理操作

**1. 强制解绑设备**
- **使用场景**: 客户设备丢失、损坏或需要紧急释放席位
- **操作流程**: 
  1. 管理员在客户详情页面点击"强制解绑"
  2. 系统弹出确认对话框，要求输入解绑原因
  3. 确认后，系统将设备状态标记为`force_unbound`
  4. 释放对应席位，`used_seats`减1
  5. 记录操作日志

**2. 授权码状态管理**
- **禁用授权码**: 禁止新的激活，已激活设备继续有效
- **启用授权码**: 重新允许新设备激活
- **修改席位数**: 仅允许增加席位，不允许减少（防止数据不一致）

**3. 紧急试用授权生成**
- **使用场景**: 为潜在客户快速提供试用授权
- **操作**: 生成30天有效期的临时授权码，最大席位数为1

### 6.3 系统管理功能

#### 6.3.1 密钥管理
- **查看当前活跃密钥**: 显示RSA密钥对的创建时间和使用状态
- **生成新密钥对**: 用于密钥轮换（需要谨慎操作）
- **密钥备份**: 导出密钥用于灾难恢复

#### 6.3.2 系统日志
记录所有重要操作：
- 授权码创建/修改/禁用
- 设备激活/解绑
- 管理员登录/操作
- 系统错误和异常

#### 6.3.3 数据库维护
- **数据备份**: 定期备份SQLite数据库文件
- **数据清理**: 清理过期的解绑记录和日志
- **统计报告**: 生成授权使用情况统计

### 6.4 管理员数据表设计

```sql
-- 管理员账户表
CREATE TABLE admin_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL, -- bcrypt哈希
    totp_secret VARCHAR(32), -- TOTP密钥
    is_active INTEGER DEFAULT 1,
    last_login DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 操作日志表
CREATE TABLE admin_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    admin_id INTEGER,
    action VARCHAR(100) NOT NULL, -- 操作类型
    target_type VARCHAR(50), -- 操作对象类型 (authorization, license, system)
    target_id VARCHAR(100), -- 操作对象ID
    details TEXT, -- 操作详情JSON
    ip_address VARCHAR(45),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (admin_id) REFERENCES admin_users (id)
);

-- 系统配置表
CREATE TABLE system_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    description TEXT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 7. API接口设计 (文件交换模式)

### 7.1 客户端API

所有客户端接口（除登录外）都需要在HTTP Header中提供`Authorization: Bearer <session_token>`。

#### 7.1.1 客户登录接口

```http
POST /api/login
Content-Type: application/json

{
    "authorization_code": "...",
    "captcha_token": "..."
}
```
**成功响应**: 返回JSON `{ "status": "success", "session_token": "a-jwt-or-opaque-token" }`。
**失败响应**: 返回401 Unauthorized。

#### 7.1.2 获取控制台信息

```http
GET /api/dashboard
```
**成功响应**: 返回JSON，包含席位信息和设备列表。
```json
{
    "customer_name": "...",
    "seats_info": { "used": 3, "total": 10 },
    "activated_devices": [
        { "hostname": "...", "machine_id": "...", "issued_at": "...", "expires_at": "...", "license_download_link": "/api/licenses/..." }
    ],
    "unbound_devices": [ ... ]
}
```

#### 7.1.3 新设备授权 (批量)

```http
POST /api/actions/activate-licenses
Content-Type: multipart/form-data

// 表单字段:
// bind_files: (multiple file uploads)
```
**成功响应**: 返回一个包含多个`.license`文件的ZIP压缩包。
**失败响应**: 返回JSON错误信息（如席位不足）。

#### 7.1.4 转移授权

```http
POST /api/actions/transfer-license
Content-Type: multipart/form-data

// 表单字段:
// unbind_file: (file upload)
// bind_file: (file upload)
```
**成功响应**: 返回新的`.license`文件流供下载。
**失败响应**: 返回JSON错误信息（如解绑凭证无效）。

#### 7.1.5 注销登录

```http
POST /api/logout
Authorization: Bearer <session_token>
```
**成功响应**: 返回JSON `{ "status": "success", "message": "注销成功" }`。
**失败响应**: 返回401 Unauthorized（如果token无效）。

**说明**: 
- 服务端收到注销请求后，应将对应的`session_token`加入黑名单或从有效token列表中移除。
- 客户端收到成功响应后，应清除本地存储的`session_token`并跳转到登录页面。
- 如果使用JWT token，可以通过维护一个黑名单来实现token失效。
- 如果使用服务端session，直接删除对应的session记录即可。

### 7.2 管理员API

所有管理员接口都需要在HTTP Header中提供`Authorization: Bearer <admin_session_token>`。

#### 7.2.1 管理员登录

```http
POST /api/admin/login
Content-Type: application/json

{
    "username": "admin",
    "password": "password",
    "totp_code": "123456"
}
```

#### 7.2.2 授权码管理

**创建授权码**
```http
POST /api/admin/authorizations
Content-Type: application/json

{
    "customer_name": "张三公司",
    "authorization_code": "ABC-DEF-001", // 可选，不提供则自动生成
    "max_seats": 10,
    "duration_years": 1,
    "latest_expiry_date": "2025-12-31T23:59:59Z" // 可选
}
```

**获取授权码列表**
```http
GET /api/admin/authorizations?page=1&limit=20&search=张三&status=active
```

**更新授权码**
```http
PUT /api/admin/authorizations/{id}
Content-Type: application/json

{
    "customer_name": "张三公司",
    "max_seats": 15, // 只能增加，不能减少
    "status": 1 // 1:启用 0:禁用
}
```

#### 7.2.3 设备管理

**强制解绑设备**
```http
POST /api/admin/licenses/{license_id}/force-unbind
Content-Type: application/json

{
    "reason": "设备丢失"
}
```

**获取客户详情**
```http
GET /api/admin/authorizations/{id}/details
```

#### 7.2.4 系统管理

**获取系统统计**
```http
GET /api/admin/dashboard
```

**获取操作日志**
```http
GET /api/admin/logs?page=1&limit=50&action=create_authorization
```

**数据库备份**
```http
POST /api/admin/system/backup
```

## 8. 客户端集成方案

### 8.1 Python客户端 (OCR2Doc)

`license_manager.py`需要重构：

```python
# license_manager.py
class LicenseManager:
    def __init__(self, license_path="app.license"):
        # ...

    def get_machine_id(self) -> str:
        """获取机器唯一标识"""
        # ...
    
    def generate_bind_file(self, output_path: str):
        """生成.bind请求文件, 包含机器ID和主机名"""
        # ...

    def import_license_file(self, license_path: str) -> bool:
        """导入并验证.license授权文件"""
        # 1. 验证签名
        # 2. 验证机器ID
        # 3. 保存授权
        # 4. 记录安全时间戳
        # ...

    def generate_unbind_file(self, output_path: str) -> bool:
        """生成.unbind解绑凭证并使本地授权失效"""
        # ...

    def is_license_valid(self) -> (bool, str):
        """
        检查授权有效性。
        返回 (是否有效, 状态信息)
        例如: (True, "正式版, 有效期至 2025-07-30"), 
             (False, "授权已过期"),
             (False, "系统时间异常，请修正")
        """
        # ...
```

### 8.2 功能控制

所有核心功能的入口处，统一调用 `is_license_valid()` 进行检查。

```python
def some_core_function(self, ...):
    is_valid, message = self.config.license_manager.is_license_valid()
    if not is_valid:
        raise Exception(f"操作失败: {message}")
    # ... 执行核心逻辑
```

## 9. 授权模型与扩展

### 9.1 授权码核心属性

每个`authorization_code`都关联了一套核心的授权规则，在签发时确定：
-   `max_seats`: 该授权码下总共可以激活的设备数量上限。
-   `used_seats`: 当前已激活的设备数量。`max_seats - used_seats` 即为剩余可用席位。
-   `duration_years`: 从激活时刻算起，授权的有效年限。可设为99或更大值代表"永久"。
-   `latest_expiry_date`: 一个固定的最晚日期，无论何时激活，授权有效期都不能超过该日期。此字段优先级高于`duration_years`。

### 9.2 授权有效期计算规则

当一个新设备被激活时，其`.license`文件中的有效期`expires_at`按以下规则计算：
-   `expires_at = MIN( 激活时间 + duration_years, latest_expiry_date )`
-   这样做可以灵活地为客户设置"订阅制"（例如，无论何时购买，服务都在特定日期结束）或"激活计时制"的授权模式。

### 9.3 授权扩充与续期

如果客户需要增加授权数量（扩充席位）或延长已购授权的有效期（续期），**推荐的方式是为客户签发一个新的授权码**，并设定新的`max_seats`、`duration_years`或`latest_expiry_date`。

这么设计主要考虑到：
-   **离线设备更新困难**：原授权码下的设备已经离线部署，无法方便地在线更新其授权文件来延长有效期。
-   **规则清晰**: 为新的采购合同签发新的授权码，可以使授权规则、有效期、设备列表的管理更加清晰，避免新旧规则混合造成混乱。

## 10. 授权状态

| 状态 | 描述 | 获取方式 |
|---|---|---|
| **未授权** | 软件无法使用任何核心功能，只能进入激活界面。 | 软件初始状态。 |
| **试用授权** | 功能完整，但有较短的有效期（如30天）。 | 管理员在服务端为特定授权码生成一个短期有效的`.license`文件。 |
| **正式授权** | 功能完整，有较长的有效期（如1年或永久）。 | 客户使用购买的授权码正常激活。 |

---

## 11. 客户端Go示例 (用于测试服务端)

提供一个简单的Go程序，模拟客户端行为，方便 `LicenseCenter` 的独立开发与测试。

```go
package main

import (
	"crypto/sha256"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"os"
	"time"
)

// 模拟获取机器ID
func getMachineID() string {
	// 在真实场景中，这里应该采集CPU、主板、硬盘等硬件信息
	// 为方便测试，我们使用一个固定的字符串
	dummyHardwareInfo := "cpu:intel-i9;motherboard:asus-z790;disk:samsung-980pro"
	hash := sha256.Sum256([]byte(dummyHardwareInfo))
	return hex.EncodeToString(hash[:])
}

// BindFile 文件结构
type BindFile struct {
	Hostname    string    `json:"hostname"`
	MachineID   string    `json:"machine_id"`
	RequestTime time.Time `json:"request_time"`
}

func main() {
	if len(os.Args) < 2 {
		fmt.Println("用法: go run . <action>")
		fmt.Println("actions: generate-bind")
		return
	}

	action := os.Args[1]

	switch action {
	case "generate-bind":
		machineID := getMachineID()
		hostname, err := os.Hostname()
		if err != nil {
			hostname = "unknown"
		}
		bindData := BindFile{
			Hostname:    hostname,
			MachineID:   machineID,
			RequestTime: time.Now().UTC(),
		}

		fileData, err := json.MarshalIndent(bindData, "", "  ")
		if err != nil {
			panic(err)
		}

		fileName := "request.bind"
		err = ioutil.WriteFile(fileName, fileData, 0644)
		if err != nil {
			panic(err)
		}
		fmt.Printf("成功生成绑定文件: %s\n", fileName)
		fmt.Printf("主机名: %s\n", hostname)
		fmt.Printf("机器ID: %s\n", machineID)

	default:
		fmt.Println("未知操作:", action)
	}
}
```

将以上代码保存于`LicenseCenter/test_client/main.go`，即可用于生成测试用的`.bind`文件。

## 12. 系统部署与初始化

### 12.1 初始化步骤

1. **数据库初始化**
   ```sql
   -- 创建数据库表结构
   -- 插入初始RSA密钥对
   -- 创建默认管理员账户
   ```

2. **管理员账户设置**
   ```sql
   INSERT INTO admin_users (username, password_hash, totp_secret, is_active) 
   VALUES ('admin', '$2b$12$...', 'BASE32_TOTP_SECRET', 1);
   ```

3. **系统配置**
   ```sql
   INSERT INTO system_config (config_key, config_value, description) VALUES
   ('session_timeout', '1800', '会话超时时间(秒)'),
   ('max_bind_files_per_request', '10', '单次批量激活最大文件数'),
   ('captcha_enabled', 'true', '是否启用验证码'),
   ('backup_retention_days', '30', '备份文件保留天数');
   ```

### 12.2 安全建议

1. **生产环境部署**
   - 更改默认管理员密码
   - 配置HTTPS证书
   - 设置防火墙规则，仅允许必要端口访问
   - 定期备份数据库文件

2. **密钥管理**
   - RSA私钥文件权限设置为600
   - 定期备份密钥文件到安全位置
   - 考虑使用硬件安全模块(HSM)存储密钥

3. **日志监控**
   - 监控异常登录尝试
   - 记录所有管理员操作
   - 设置磁盘空间告警

### 12.3 维护操作

**定期任务**：
- 清理过期的会话token
- 压缩和归档历史日志
- 检查数据库完整性
- 更新系统时间同步

**故障处理**：
- 数据库损坏恢复流程
- 密钥丢失应急方案
- 系统迁移步骤 

## 4. 安全机制

### 4.1 文件加密机制

为了防止离线授权文件被篡改，我们实现了混合加密机制：

**加密原理：**
- **对称加密**：使用AES-256-GCM加密JSON数据，确保机密性和完整性
- **非对称加密**：使用RSA-2048-OAEP加密AES密钥，确保密钥安全传输
- **随机密钥**：每个文件使用不同的随机AES密钥，增强安全性

**加密流程：**
1. 生成随机的256位AES密钥
2. 使用AES-GCM加密JSON数据
3. 使用服务端RSA公钥加密AES密钥
4. 将加密的数据和密钥组合并Base64编码

**文件格式：**
- **明文格式**（调试用）：标准JSON格式
- **加密格式**（生产用）：Base64编码的加密数据

### 4.2 机器ID生成最佳实践

为了确保机器ID的唯一性和稳定性，系统使用多种硬件信息的组合：

**推荐的硬件信息组合：**

1. **主板序列号（Motherboard Serial Number）**
   - Windows: 通过WMI查询Win32_BaseBoard.SerialNumber
   - Linux: 读取/sys/class/dmi/id/board_serial
   - 特点: 硬件级别唯一，不易改变

2. **系统UUID（System UUID）**
   - Windows: 通过WMI查询Win32_ComputerSystemProduct.UUID
   - Linux: 读取/sys/class/dmi/id/product_uuid
   - macOS: 通过system_profiler获取Hardware UUID
   - 特点: 系统级别唯一标识

3. **第一个物理网卡MAC地址**
   - 跨平台: 通过网络接口API获取
   - 排除虚拟接口: docker、bridge、veth、tap、tun等
   - 特点: 网络硬件唯一，但可能被修改

4. **硬盘序列号（First Disk Serial Number）**
   - Windows: 通过WMI查询Win32_DiskDrive.SerialNumber
   - Linux: 读取/sys/block/*/serial或使用lsblk
   - 特点: 存储硬件唯一

**生成算法：**
```
machine_id = MD5(组合多个硬件信息)
格式: 32位十六进制字符串
```

**优势：**
- **多重保障**: 即使某个硬件信息获取失败，仍可生成稳定ID
- **跨平台兼容**: 支持Windows、Linux、macOS
- **抗虚拟化**: 能区分物理机和虚拟机
- **防篡改**: 组合多个硬件特征，难以伪造

**回退机制：**
当主要硬件信息无法获取时：
1. Linux: 使用/etc/machine-id或/var/lib/dbus/machine-id
2. 所有平台: 使用主机名+物理MAC+操作系统类型的组合

### 4.3 多层防护 